# A-lightweight-Unsupervised-Feature-Extractor
## ç‰¹è‰²
æœ¬æ¨¡å‹å¯ç”¨æ–¼äºŒéšæ®µçš„ç‰©ä»¶è¿½è¹¤ä»»å‹™ä¸­ï¼Œè—‰ç”±YOLOä½œç‚ºä¸Šå±¤çš„ç‰¹å¾µæ“·å–å·¥å…·èåˆå¡çˆ¾æ›¼æ¿¾æ³¢å™¨èˆ‡åŒˆç‰™åˆ©ç®—æ³•å®Œæˆç‰©ä»¶è¿½è¹¤ï¼Œåœ¨ç›¸é—œç‰©ä»¶ä¸ç§»å‡ºç•«é¢çš„ç†æƒ³æƒ…æ³ä¸‹èƒ½è¼•æ˜“å¯¦ç¾è¶…é2åˆ†é˜ä»¥ä¸Šçš„ç©©å®šè¿½è¹¤è€Œä¸ç”¢ç”ŸID Switchã€‚
## ç°¡ä»‹
æœ¬æ¨¡å‹é€éROIæŠ€è¡“ä»¥ç•¶ä¸‹çš„åµæ¸¬æ¡†åˆ‡åˆ†YOLOéª¨å¹¹ç¶²è·¯ä¸­çš„æ·±å±¤ç‰¹å¾µè¨“ç·´è€Œæˆï¼Œä»¥éª¨å¹¹ç¶²è·¯æœ€å¾Œä¸€å±¤çš„ `SPP-CSPC` ä½œç‚ºå”¯ä¸€çš„ç‰¹å¾µä¾†æºï¼Œä¸¦å°‡å…¶ä»¥é‚Šç•Œæ¡†åˆ‡åˆ†å¾Œå½¢æˆæ•¸å€‹ä¸åŒçš„ç‰‡æ®µï¼Œæœ€çµ‚å°‡å„å€‹ä¸åŒçš„ç‰‡æ®µé‡å¡‘ç‚º(10,10)çš„å½¢ç‹€æ–¹ä¾¿å¾ŒçºŒçš„è¨“ç·´èˆ‡æ¨è«–ã€‚

ä½œç‚ºä¸€å€‹ Encoder é€éæ¥æ”¶å½¢ç‹€ç‚º `[1, 512, Hf, Wf]` çš„å¼µé‡é€²è¡Œè¨“ç·´èˆ‡æ¨è«–,é€é ROI Align å°‡å°æ‡‰å€åŸŸçš„ç‰¹å¾µè£å‰ªèˆ‡é‡æ¡æ¨£ç‚ºå›ºå®šå¤§å°ä¹‹ ROI ç‰¹å¾µ ä¸¦ä¾æ“šç•¶ä¸‹åµæ¸¬æ¡†çš„æ•¸é‡å°‡ç‰¹å¾µå½¢ç‹€é‡å¡‘ç‚º `[N, 512, 10, 10]`ï¼Œå…¶ä¸­ 
ğ‘ ç‚ºè©²å½±åƒä¸­åµæ¸¬æ¡†çš„æ•¸é‡ã€‚

| éšæ®µ           | å¼µé‡å½¢ç‹€                       | èªªæ˜                  |
| ------------ | -------------------------- | ------------------- |
| Backbone è¼¸å‡º  | `[1, 512, Hf, Wf]`         | YOLOv7 SPP-CSPC ç‰¹å¾µåœ– |
| åµæ¸¬æ¡†          | `[N, 4]`                   | æ¯å€‹ç‰©ä»¶çš„ bounding box  |
| ROI Align è¼¸å…¥ | `[1, 512, Hf, Wf] + [N,5]` | åŠ ä¸Š batch index |
| ROI Align è¼¸å‡º | `[N, 512, 10, 10]`         | å›ºå®šå¤§å° ROI ç‰¹å¾µ         |

> [!NOTE]
>
>  ROI Align æ™‚ç‚ºå–®åœ–æ“·å–å› æ­¤è©²éšç«¯çš„batch index çš†ç‚º0ï¼Œç›´è‡³æœé›†å®Œå…¨è³‡æ–™é›†ä¸­åœ–åƒä¹‹ ROI ç‰¹å¾µæ‰é€éDataLoaderå°‡ ROI Dataset ç·¨å…¥æ­£å¼çš„batch index  
---
ç‚ºé©—è­‰æœ¬æ¨¡å‹æ–¼ä¸åŒç•«é¢ä¸‹çš„ç›¸åŒç‰©ä»¶ä¹‹è¾¨è­˜èƒ½åŠ›ï¼Œåˆ©ç”¨ä¸åŒå¹€ä¸‹çš„æ¨™è¨˜åœ–åƒè©•ä¼°æ¨¡å‹çš„è¾¨è­˜èƒ½åŠ›ï¼Œè©²é©—è­‰è³‡æ–™é›†é€éé€éæˆå°çš„åœ–åƒèˆ‡æ¨™è¨˜æª”æ¨¡æ“¬ä¸åŒå¹€ä¸‹çš„åœ–åƒè¼¸å…¥ï¼Œå…¶ä¸­ç‚ºç¢ºä¿æŒ‡æ¨™è¨ˆç®—å¾—ä»¥æ­£å¸¸é€²è¡Œæ¨™è¨˜æª”ä¸­è‡³å°‘å­˜åœ¨ä¸€å€‹è·¨è¶Šä¸åŒå¹€çš„ç‰©ä»¶ã€‚


| æŒ‡æ¨™ | å®šç¾© | å€¼åŸŸ / æ–¹å‘ | note |
|---|---|---|---|
| **Top-1 Accuracy** | æ­£ç¢ºåŒ¹é…çš„å€™é¸ç‰©ä»¶æ˜¯å¦æ’åœ¨ç¬¬ 1 åï¼š<br>$$\text{Top1}=\frac{1}{Q_v}\sum_{i=1}^{Q_v}\mathbf{1}\big[\arg\max_j P_{ij}=gt_i\big]$$ | $$[0,1],\ \text{è¶Šå¤§è¶Šå¥½}$$ | æœ€ç›´è§€çš„è¾¨è­˜èƒ½åŠ›æŒ‡æ¨™ï¼Œä»£è¡¨æ¨¡å‹ã€Œç¬¬ä¸€å€‹é¸æ“‡ã€æ˜¯å¦æ­£ç¢º |
| **Mean Rank** | æ­£ç¢ºç›®æ¨™åœ¨æ’åºä¸­çš„å¹³å‡åæ¬¡ï¼š<br>$$\text{MeanRank}=\frac{1}{Q_v}\sum_{i=1}^{Q_v}\text{rank}_i$$ | $$[1,N],\ \text{è¶Šå°è¶Šå¥½}$$ | æ¨¡å‹é€šå¸¸æŠŠæ­£ç¢ºç›®æ¨™æ’åœ¨ç¬¬å¹¾åï¼Œè¶Šé å‰ä»£è¡¨å€åˆ†èƒ½åŠ›è¶Šå¥½ |
| **MRR (Mean Reciprocal Rank)** | åæ¬¡å€’æ•¸çš„å¹³å‡å€¼ï¼š<br>$$\text{MRR}=\frac{1}{Q_v}\sum_{i=1}^{Q_v}\frac{1}{\text{rank}_i}$$ | $$(0,1],\ \text{è¶Šå¤§è¶Šå¥½}$$ | å¼·èª¿å‰å¹¾åçš„é‡è¦æ€§ï¼Œrank=1 å½±éŸ¿æœ€å¤§ |
| **Recall@K** | æ­£ç¢ºç›®æ¨™æ˜¯å¦è½åœ¨å‰ \(K\) åï¼š<br>$$\text{Recall@}K=\frac{1}{Q_v}\sum_{i=1}^{Q_v}\mathbf{1}[\text{rank}_i\le K]$$ | $$[0,1],\ \text{è¶Šå¤§è¶Šå¥½}$$ | æ¨¡å‹åœ¨ Top-\(K\) å…§æ˜¯å¦èƒ½ã€Œæ‰¾å¾—åˆ°æ­£è§£ã€ |


| æŒ‡æ¨™ | æ•¸å€¼ | note                   |
|---|---| -------------------- |
| Top-1 Accuracy | 0.659444 |ç´„ 66% çš„æŸ¥è©¢åœ¨ç¬¬ä¸€åå°±é¸åˆ°æ­£ç¢ºç›®æ¨™ |
| Mean Rank | 1.720556 |æ­£ç¢ºç›®æ¨™å¹³å‡æ’åœ¨ç¬¬ 1ï½2 å      |
| MRR (Mean Reciprocal Rank) | 0.796589 |å¤šæ•¸æ­£ç¢ºç­”æ¡ˆé›†ä¸­åœ¨å‰å¹¾å         |
| Recall@5 | 0.953704 |95.4% çš„æ­£ç¢ºç­”æ¡ˆåœ¨å‰ 5 å    |
| Recall@10 | 1.000000 |æ‰€æœ‰æ­£ç¢ºç­”æ¡ˆéƒ½åœ¨å‰ 10 å       |
| Num. Queries | 6.466667 |æ¯çµ„æ¨£æœ¬å¹³å‡ç´„ 6.5 å€‹æŸ¥è©¢ç‰©ä»¶    |
| Num. Valid | 4.266667 |å…¶ä¸­ç´„ 4.3 å€‹æœ‰å°æ‡‰çš„çœŸå¯¦åŒ¹é…    |

>[!NOTE]
>
> `Recall@10` æœ‰å¾…æ“´å……é©—è­‰è³‡æ–™é›†ä»¥æå‡å¯ä¿¡åº¦
---

## è¨“ç·´ç’°å¢ƒ

æœ¬æ¨¡å‹é€éå…©å¼µ `NVIDIA RTX 5000 Ada Generation` é¡¯å¡æ–¼ `Ubuntu 24.04.3` è¨“ç·´ï¼Œç¸½æ™‚æ•¸ç´„8~10å°æ™‚

| é …ç›®           | è¦æ ¼                                |
| ------------ | --------------------------------- |
| Python       | 3.12.3                            |
| CUDA Toolkit | 12.8 (V12.8.93)                   |
| GPU          | NVIDIA RTX 5000 Ada Generation Ã—2 |
| è¨“ç·´ Epoch     | 500                               |
| Batch Size   | 256                               |
| å¤šå¡è¨“ç·´         | DDP (torchrun)                    |

>[!NOTE]
>
> æ¨è«–æ™‚ä»¥å–®å¡é€²è¡Œï¼Œå¹³å‡VRAMEä½¿ç”¨ç‡ç´„ç‚º 9%~12%

---
## å¦‚ä½•ä½¿ç”¨
```
git clone https://github.com/ImChouOWO/A-lightweight-Unsupervised-Feature-Extractor.git
```
---
- Creat venv if you need
```
python3.12 -m venv venv312_torch
```
```
source venv312_torch/bin/activate
```
or
```
conda create -n torch312 python=3.12 -y
```
```
conda activate torch312
```
---
```
cd A-lightweight-Unsupervised-Feature-Extractor
```
```
pip intall -r requirements.txt
```

### try Val
```
python3 val.py
```
### try training
```
torchrun --nproc_per_node=2 main_train.py
```

### try tracking
```
python3 tracking.py
```